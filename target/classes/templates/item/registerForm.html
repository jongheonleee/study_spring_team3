<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>상품 등록</title>
  <link rel="stylesheet" href="/css/item/registerForm.css" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    // 렌더링할 때 에러 메시지가 존재하면, alert으로 출력
    $(document).ready(function () {
      // 컨트롤러에서 errorMsg 전달 받았는지 확인
      const errorMsg = [[${errorMsg}]];

      // errorMsg가 존재하면 경고창 띄우기(alert)
      if (errorMsg != null) {
        alert(errorMsg);
      }

      // 파일 등록 인풋 핸들러 호출
      bindDomEvent();
    })

    // 파일 등록 인풋 핸들러 정의
    function bindDomEvent() {
      $('.custom-file-input').on('change', function () {
        // 인풋에 사용자가 무언가를 입력하면 핸들러 처리
        const fileName = $(this).val().split('\\').pop();

        // 파일 이름과 확장자를 추출
        const fileExt = fileName.substring(
                          fileName.lastIndexOf('.') + 1
                        ).toLowerCase();

        // 파일 확장자 검증(jpg, jpeg, gif, png, bmp)
        if (fileExt in ['jpg', 'jpeg', 'gif', 'png', 'bmp']) {
          alert('이미지 파일만 등록 가능합니다.');
          return;
        }

        // 레이블에 파일 이름 html로 붙여주기
        $(this).siblings('.custom-file-label').html(fileName);
      })
    }
  </script>
</head>
<body>

<!-- 등록 폼 -->
<div class="container">
  <h1>상품 등록</h1>
  <form th:object="${itemFormDto}" method="post" enctype="multipart/form-data">
    <div class="form-group">
      <label for="status">판매 상태</label>
      <select th:field="*{itemSellStatus}" id="status" name="status">
        <option value="SELL">판매중</option>
        <option value="SOLD_OUT">품절</option>
      </select>
    </div>

    <div class="form-group">
      <label for="productName">상품명</label>
      <input type="text" th:field="*{itemNm}" id="productName" name="productName" placeholder="상품명을 입력해주세요">
    </div>
    <p th:if="${#fields.hasErrors('itemNm')}" th:errors="*{itemNm}" class="fieldError">Incorrect data</p>

    <div class="form-group">
      <label for="price">가격</label>
      <input type="text" id="price" th:field="*{price}" name="price" placeholder="상품의 가격을 입력해주세요">
    </div>
    <p th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="fieldError">Incorrect data</p>

    <div class="form-group">
      <label for="stock">재고</label>
      <input type="text" id="stock" th:field="*{stockNumber}" placeholder="상품의 재고를 입력해주세요">
    </div>
    <p th:if="${#fields.hasErrors('stockNumber')}" th:errors="*{stockNumber}" class="fieldError">Incorrect data</p>


    <div class="form-group">
      <label for="description">상품 상세 내용</label>
      <textarea id="description" th:field="*{itemDetail}" name="description" placeholder="상품의 상세 내용을 입력해주세요"></textarea>
    </div>
    <p th:if="${#fields.hasErrors('itemDetail')}" th:errors="*{itemDetail}" class="fieldError">Incorrect data</p>


    <div th:if="${#lists.isEmpty(itemFormDto.itemImgDtoList)}">
      <div class="form-group" th:each="num: ${#numbers.sequence(1,5)}">
        <div class="custom-file img-div">
          <input type="file" class="custom-file-input" name="itemImgFile">
          <label class="custom-file-label" th:text="상품이미지 + ${num}"></label>
        </div>
      </div>
    </div>

    <div th:if = "${not #lists.isEmpty(itemFormDto.itemImgDtoList)}">
      <div class="form-group" th:each="itemImgDto, status: ${itemFormDto.itemImgDtoList}">
        <div class="custom-file img-div">
          <label class="custom-file-label" th:text="${not #strings.isEmpty(itemImgDto.oriImgName)} ? ${itemImgDto.oriImgName} : '상품이미지' + ${status.index+1}"></label>
          <input type="file" class="custom-file-input" name="itemImgFile">
          <input type="hidden" name="itemImgIds" th:value="${itemImgDto.id}">
        </div>
      </div>
    </div>

    <div th:if="${#strings.isEmpty(itemFormDto.id)}" style="text-align: center">
      <button th:formaction="@{/admin/item/new}" type="submit" class="btn btn-primary">저장</button>
    </div>
    <div th:unless="${#strings.isEmpty(itemFormDto.id)}" style="text-align: center">
      <button th:formaction="@{'/admin/item/' + ${itemFormDto.id} }" type="submit" class="btn btn-primary">수정</button>
    </div>

  </form>
</div>
</body>
</html>